<%@page import="java.io.*"%>
<%@page import="com.kd.kineticSurvey.impl.RemedyHandler"%>
<%!
    public static class WorkInformation {
        public static final String FORM_NAME = "KAPP_Fulfillment_WorkInformation";

        public static final String FIELD_ID = "1";
        public static final String FIELD_CREATE_DATE = "3";
        public static final String FIELD_MODIFY_DATE = "6";
        public static final String FIELD_SUBMITTER = "2";
        public static final String FIELD_INFORMATION = "740000009";
        public static final String FIELD_VISIBILITY_FLAG = "740000045";
        public static final String FIELD_ATTACHMENT = "740000032";
        public static final String FIELD_ATTACHMENTNAME = "740000046";
        public static final String FIELD_WORK_ORDER_ID = "740000007";

        public static final String[] FIELD_IDS = new String[] {
            FIELD_ID, FIELD_CREATE_DATE, FIELD_ATTACHMENTNAME, FIELD_INFORMATION,
            FIELD_VISIBILITY_FLAG, FIELD_ATTACHMENT, FIELD_SUBMITTER, FIELD_MODIFY_DATE
        };

        public static boolean hasPublicWorkInformation(HelperContext context, String workOrderID) {
            String qualification = "'WorkOrderID'=\""+workOrderID+"\" AND 'Visibility'=\"Public\"";;
            int count = ArsBase.count(context, FORM_NAME, qualification);
            return (count>0)? true : false;
        }

        public static int count(HelperContext context, String qualification) {
            return ArsBase.count(context, FORM_NAME, qualification);
        }

        public static WorkInformation[] find(HelperContext context, String qualification) {
            WorkInformation[] results = new WorkInformation[0];

            SimpleEntry[] entries = ArsBase.find(context, FORM_NAME, qualification, FIELD_IDS);
            if (entries != null && entries.length > 0) {
                results = new WorkInformation[entries.length];
                for(int i=0;i<results.length;i++) {
                    results[i] = new WorkInformation(entries[i]);
                }
            }

            return results;
        }

        public static WorkInformation findSingle(HelperContext context, String qualification) {
            SimpleEntry entry = ArsBase.findSingle(context, FORM_NAME, qualification, FIELD_IDS);
            WorkInformation result = new WorkInformation(entry);

            return result;
        }

        public static WorkInformation findSingleById(HelperContext context, String workOrderId) {
            String qualification = "'" + FIELD_ID + "'=\"" + workOrderId + "\"";
            SimpleEntry entry = ArsBase.findSingle(context, FORM_NAME, qualification, FIELD_IDS);
            WorkInformation result = new WorkInformation(entry);

            return result;
        }

        public static WorkInformation[] find(HelperContext context, String qualification, String[] sortFields, Integer chunkSize, Integer recordOffset, Integer sortOrder) {
            WorkInformation[] results = new WorkInformation[0];

            SimpleEntry[] entries = ArsBase.find(context, FORM_NAME, qualification, FIELD_IDS, sortFields, chunkSize, recordOffset, sortOrder);
            if (entries != null && entries.length > 0) {
                results = new WorkInformation[entries.length];
                for(int i=0;i<results.length;i++) {
                    results[i] = new WorkInformation(entries[i]);
                }
            }

            return results;
        }

        public static String saveWorkInformation(HelperContext context, String sessionID, String workOrderID,
            String notes, String visibilityFlag, String attachmentID, String fileName) {
            String createdId = null;

            SimpleEntry entrySave = new SimpleEntry();
            entrySave.setSchemaName(FORM_NAME);
            entrySave.setEntryItems(new Hashtable());
            entrySave.setEntryFieldValue(FIELD_WORK_ORDER_ID, workOrderID);
            entrySave.setEntryFieldValue(FIELD_INFORMATION, notes);

            // Build the helper
            ArsHelper helper = null;
            try {
                helper = new ArsHelper(context, FORM_NAME);
            } catch (Exception e) {
                throw new RuntimeException("Unable to initialize an ArsHelper instance.", e);
            }

            try {
                createdId = helper.doSetSimpleEntry(entrySave, true);
            } catch (Exception e) {
                throw new RuntimeException("There was a problem saving the "+FORM_NAME+" record.", e);
            }
            return createdId;
        }

        public static String saveWorkInformationWithAttachment(HelperContext context, String workOrderID,
            String notes, String fileName, byte[] attachmentContent) {
            String createdId = null;

            SimpleEntry entrySave = new SimpleEntry();
            entrySave.setSchemaName(FORM_NAME);
            entrySave.setEntryItems(new Hashtable());
            entrySave.setEntryFieldValue(FIELD_WORK_ORDER_ID, workOrderID);
            entrySave.setEntryFieldValue(FIELD_INFORMATION, notes);

            if (attachmentContent != null && attachmentContent.length > 0 &&
                fileName != null && fileName.length() > 0) {
                entrySave.setEntryFieldValue(FIELD_ATTACHMENTNAME, fileName);
                try {
                    com.bmc.arsys.api.AttachmentValue aValue = new com.bmc.arsys.api.AttachmentValue(fileName, attachmentContent);
                    entrySave.setEntryFieldValue(FIELD_ATTACHMENT, new com.bmc.arsys.api.Value(aValue));
                } catch (Exception e) {
                    throw new RuntimeException("Error occured when creating an AttachmentValue for the Work Order Note.",e);
                }

            }

            // Build the helper
            ArsHelper helper = null;
            try {
                helper = new ArsHelper(context, FORM_NAME);
            } catch (Exception e) {
                throw new RuntimeException("Unable to initialize an ArsHelper instance.", e);
            }

            try {
                createdId = helper.doSetSimpleEntry(entrySave, true);
            } catch (Exception e) {
                throw new RuntimeException("There was a problem saving the "+FORM_NAME+" record.", e);
            }
            return createdId;
        }

        private SimpleEntry entry = null;

        public WorkInformation(SimpleEntry entry) {
            this.entry = entry;
        }

        public String getId() {return entry.getEntryFieldValue(FIELD_ID);}
        public String getCreateDate() {return entry.getEntryFieldValue(FIELD_CREATE_DATE);}
        public String getModifyDate() {return entry.getEntryFieldValue(FIELD_MODIFY_DATE);}
        public String getSubmittedBy() {return entry.getEntryFieldValue(FIELD_SUBMITTER);}
        public String getWorkOrderID() {return entry.getEntryFieldValue(FIELD_WORK_ORDER_ID);}
        public String getInformation() {return entry.getEntryFieldValue(FIELD_INFORMATION);}
        public String getVisibilityFlag() {return entry.getEntryFieldValue(FIELD_VISIBILITY_FLAG);}
        public String getAttachment() {return entry.getEntryFieldValue(FIELD_ATTACHMENT);}
        public String getAttachmentName() {return entry.getEntryFieldValue(FIELD_ATTACHMENTNAME);}
        public String getAttachmentUrl(HttpServletRequest request) {
            // Build up the Work Order Url
            String patternStr="(\\A.*?/kinetic/)";
            Pattern p = Pattern.compile(patternStr);
            Matcher m = p.matcher(request.getRequestURL());

            String baseRequestUrl = "";
            if (m.find()) {
                 baseRequestUrl = m.group(1);
            }

            StringBuilder sb = new StringBuilder();
            sb.append(baseRequestUrl);
            sb.append("DownloadAttachment/");
            sb.append(FORM_NAME).append("/");
            sb.append(FIELD_ATTACHMENT).append("/");
            sb.append(getId());

            return sb.toString();
        }
    }
%>
